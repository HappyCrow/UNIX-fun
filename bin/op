#!/bin/bash

#set -x

# generic file opener inspired by the plumber tool from Plan 9
# cf. http://doc.cat-v.org/plan_9/4th_edition/papers/plumb

OPRC=${HOME}/.oprc

if [[ -z $EDITOR ]] ; then
    EDITOR="emacs" # the best editor on Earth
fi

input=$1
extension=`echo $input | awk -F'.' '{print $NF}'`

if [ "$#" != 1 ] ; then
    echo "usage: "$0" input_file"
    exit 1
elif [ "$input" == "EDIT" ] ; then
    $EDITOR $OPRC
    exit 0
fi

if [ ! -f $OPRC ] ; then
    # use defaults; keep them sorted
    cat <<EOF > $OPRC
avi:vlc
bmp:eog
c:$EDITOR
csv:libreoffice
eps:evince
gif:eog
h:$EDITOR
html:firefox
jpeg:eog
jpg:eog
ml:$EDITOR
mli:$EDITOR
mp3:nvlc
mpeg:vlc
mpg:vlc
ods:libreoffice
pdf:evince
png:eog
ps:evince
py:$EDITOR
sh:$EDITOR
tex:$EDITOR
tif:eog
txt:$EDITOR
EOF
fi

found=0

while read line ; do
    ext=`echo $line | cut -d':' -f1`
    app=`echo $line | cut -d':' -f2`
    if [ "$ext" == "$extension" ] ; then
        found=1
        $app $input &
    fi
done < $OPRC

if [ "$found" == 0 ] ; then
    echo "FATAL: don't know how to open "$input
    echo "type 'op EDIT' to edit the association list"
    exit 1
fi
